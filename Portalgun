-- Create the RemoteEvent in ReplicatedStorage
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local remoteEvent = Instance.new("RemoteEvent")
remoteEvent.Name = "PortalEvent"
remoteEvent.Parent = ReplicatedStorage

-- Server-side Script
local function setupServer()
    local portal1 = nil
    local portal2 = nil

    -- Function to create a portal
    local function createPortal(position, color)
        local portal = Instance.new("Part")
        portal.Size = Vector3.new(5, 10, 1)
        portal.Anchored = true
        portal.CanCollide = false
        portal.CFrame = CFrame.new(position)
        portal.BrickColor = BrickColor.new(color)
        portal.Touched:Connect(function(hit)
            if hit.Parent:FindFirstChild("Humanoid") then
                teleportPlayer(portal)
            end
        end)
        portal.Parent = workspace
        return portal
    end

    -- Function to teleport player
    local function teleportPlayer(portal)
        local destinationPortal = (portal == portal1) and portal2 or portal1
        if destinationPortal then
            local character = portal.Parent
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = destinationPortal.CFrame + Vector3.new(0, 5, 0)
            end
        end
    end

    -- Handle portal creation and teleportation
    remoteEvent.OnServerEvent:Connect(function(player, action, position)
        if action == "createPortal1" then
            portal1 = createPortal(position, "Bright blue")
        elseif action == "createPortal2" then
            portal2 = createPortal(position, "Bright orange")
        elseif action == "resetPortals" then
            if portal1 then portal1:Destroy() portal1 = nil end
            if portal2 then portal2:Destroy() portal2 = nil end
        end
    end)
end

-- Run the server setup function
setupServer()

-- Client-side Script
local player = game.Players.LocalPlayer
local mouse = player:GetMouse()

-- Create the Portal Gun
local backpack = player.Backpack
local portalGun = Instance.new("Tool")
portalGun.Name = "Portal Gun"
portalGun.RequiresHandle = false
portalGun.CanBeDropped = false
portalGun.Parent = backpack

-- GUI for reset button
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = player:WaitForChild("PlayerGui")

local resetButton = Instance.new("TextButton")
resetButton.Size = UDim2.new(0, 100, 0, 50)
resetButton.Position = UDim2.new(0, 10, 0, 10)
resetButton.Text = "Reset Portals"
resetButton.Parent = screenGui

-- Mouse click event to shoot portals
portalGun.Activated:Connect(function()
    if not portal1 then
        remoteEvent:FireServer("createPortal1", mouse.Hit.p)
    elseif not portal2 then
        remoteEvent:FireServer("createPortal2", mouse.Hit.p)
    end
end)

-- Connect reset button
resetButton.MouseButton1Click:Connect(function()
    remoteEvent:FireServer("resetPortals")
end)

-- Allow other players to use the portals
game.Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function(char)
        if portal1 then
            portal1.Touched:Connect(function(hit)
                if hit.Parent == char then
                    teleportPlayer(portal1)
                end
            end)
        end
        if portal2 then
            portal2.Touched:Connect(function(hit)
                if hit.Parent == char then
                    teleportPlayer(portal2)
                end
            end)
        end
    end)
end)
