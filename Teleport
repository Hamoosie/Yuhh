-- Create UI
local ScreenGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local TextBox = Instance.new("TextBox")
local TeleportButton = Instance.new("TextButton")
local KnockButton = Instance.new("TextButton")

ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.Name = "TeleportGui"

Frame.Parent = ScreenGui
Frame.Size = UDim2.new(0, 200, 0, 150) -- Increased height for KnockButton
Frame.Position = UDim2.new(0, 0, 0.5, -75)

TextBox.Parent = Frame
TextBox.Size = UDim2.new(0, 140, 0, 50)
TextBox.Position = UDim2.new(0, 0, 0, 0)
TextBox.PlaceholderText = "Enter Player Name"
TextBox.Text = ""

TeleportButton.Parent = Frame
TeleportButton.Size = UDim2.new(0, 60, 0, 50)
TeleportButton.Position = UDim2.new(0, 140, 0, 0)
TeleportButton.Text = "Teleport"

KnockButton.Parent = Frame
KnockButton.Size = UDim2.new(0, 60, 0, 50)
KnockButton.Position = UDim2.new(0, 140, 0, 50)
KnockButton.Text = "Knock"

local teleporting = false
local knockActive = false
local targetPlayer = nil

local function teleportToPlayer(partialName)
    local foundPlayer = nil
    partialName = partialName:lower()

    -- Iterate through all players to find a match
    for _, player in ipairs(game.Players:GetPlayers()) do
        if string.sub(player.Name:lower(), 1, #partialName) == partialName then
            foundPlayer = player
            break
        end
    end

    if foundPlayer then
        targetPlayer = foundPlayer
        print("Teleporting to " .. foundPlayer.Name)
        local character = game.Players.LocalPlayer.Character
        local targetCharacter = foundPlayer.Character

        if character and targetCharacter and targetCharacter:FindFirstChild("HumanoidRootPart") then
            -- Teleport very close to the target and make sure character faces the target
            local targetPosition = targetCharacter.HumanoidRootPart.Position + targetCharacter.HumanoidRootPart.CFrame.LookVector * -0.5
            character:SetPrimaryPartCFrame(CFrame.new(targetPosition, targetCharacter.HumanoidRootPart.Position))
            teleporting = true
        else
            print("Teleport failed: Target player's HumanoidRootPart not found.")
        end
    else
        print("No player found with name starting with: " .. partialName)
    end
end

local function activateCombatTool()
    local backpack = game.Players.LocalPlayer.Backpack
    local tool = backpack:FindFirstChild("Combat")
    if tool then
        -- Equip the tool
        tool.Parent = game.Players.LocalPlayer.Character
        local humanoid = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid:EquipTool(tool)
            print("Combat tool equipped.")
        else
            print("Humanoid not found.")
        end
    else
        print("Combat tool not found.")
    end
end

local function knockBehindPlayer()
    if targetPlayer then
        activateCombatTool()
        knockActive = true
        while knockActive and targetPlayer do
            local character = game.Players.LocalPlayer.Character
            local targetCharacter = targetPlayer.Character

            if character and targetCharacter and targetCharacter:FindFirstChild("HumanoidRootPart") then
                -- Teleport closer and ensure the player is facing the target
                local targetPosition = targetCharacter.HumanoidRootPart.Position + targetCharacter.HumanoidRootPart.CFrame.LookVector * -0.1 -- Adjusted closer
                local characterPosition = character.HumanoidRootPart.Position
                local targetDirection = (targetCharacter.HumanoidRootPart.Position - characterPosition).unit
                character:SetPrimaryPartCFrame(CFrame.new(targetPosition, targetCharacter.HumanoidRootPart.Position))
                wait(0.1)
                local args = {
                    [1] = "ChargeButton"
                }
                game:GetService("ReplicatedStorage"):WaitForChild("MainEvent"):FireServer(unpack(args))
            else
                print("Failed to teleport behind player.")
                break
            end
        end
    else
        print("No target player to knock.")
    end
end

TeleportButton.MouseButton1Click:Connect(function()
    local partialName = TextBox.Text
    if partialName and partialName ~= "" then
        teleportToPlayer(partialName)
    else
        print("Please enter a player's name.")
    end
end)

KnockButton.MouseButton1Click:Connect(function()
    local partialName = TextBox.Text
    if partialName and partialName ~= "" then
        teleportToPlayer(partialName) -- Update target player
        if not knockActive then
            if targetPlayer then
                activateCombatTool()
                knockBehindPlayer()
            else
                print("No target player to knock.")
            end
        else
            knockActive = false
            print("Knock stopped.")
        end
    else
        print("Please enter a player's name to knock.")
    end
end)
