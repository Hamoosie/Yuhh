-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerScriptService = game:GetService("ServerScriptService")

-- Create ServerScriptService if it does not exist
local function createServerScriptService()
    local serverScriptService = ServerScriptService
    if not serverScriptService then
        serverScriptService = Instance.new("ServerScriptService")
        serverScriptService.Name = "ServerScriptService"
        serverScriptService.Parent = game
    end
    return serverScriptService
end

-- Add server-side script
local function addServerSideScript()
    local serverScriptService = createServerScriptService()
    
    -- Check if the script already exists
    local existingScript = serverScriptService:FindFirstChild("AvatarCopyScript")
    if existingScript then
        existingScript:Destroy()
    end

    -- Create the server-side script
    local serverScript = Instance.new("Script")
    serverScript.Name = "AvatarCopyScript"
    serverScript.Source = [[
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")

        local function applyOutfit(player, targetUserId)
            local character = player.Character
            if not character then return end

            -- Remove the current player's outfit
            for _, item in ipairs(character:GetChildren()) do
                if item:IsA("Shirt") or item:IsA("Pants") or item:IsA("Hat") or item:IsA("Accessory") then
                    item:Destroy()
                end
            end

            -- Load the target user's avatar
            local targetPlayer = Players:GetPlayerByUserId(targetUserId)
            if not targetPlayer or not targetPlayer.Character then return end

            local targetCharacter = targetPlayer.Character
            local outfit = targetCharacter:GetChildren()

            -- Apply the target player's outfit to the current player
            for _, item in ipairs(outfit) do
                if item:IsA("Shirt") or item:IsA("Pants") or item:IsA("Hat") or item:IsA("Accessory") then
                    local newItem = item:Clone()
                    newItem.Parent = character
                end
            end
        end

        local RemoteEvent = Instance.new("RemoteEvent")
        RemoteEvent.Name = "AvatarCopyEvent"
        RemoteEvent.Parent = ReplicatedStorage

        RemoteEvent.OnServerEvent:Connect(function(player, targetUsername)
            local success, targetUserId = pcall(function()
                return Players:GetUserIdFromNameAsync(targetUsername)
            end)
            
            if success then
                applyOutfit(player, targetUserId)
            else
                warn("Failed to get user ID")
            end
        end)
    ]]
    serverScript.Parent = serverScriptService
end

-- Create and show the client-side GUI
local function createClientGui()
    local player = Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AvatarCopyMenu"
    ScreenGui.Parent = playerGui

    local TextBox = Instance.new("TextBox")
    TextBox.Size = UDim2.new(0.3, 0, 0.1, 0)
    TextBox.Position = UDim2.new(0.35, 0, 0.4, 0)
    TextBox.PlaceholderText = "Enter Username"
    TextBox.Text = ""
    TextBox.Parent = ScreenGui

    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(0.1, 0, 0.1, 0)
    Button.Position = UDim2.new(0.45, 0, 0.55, 0)
    Button.Text = "Copy Outfit"
    Button.Parent = ScreenGui

    local ImageLabel = Instance.new("ImageLabel")
    ImageLabel.Size = UDim2.new(0.2, 0, 0.3, 0)
    ImageLabel.Position = UDim2.new(0.4, 0, 0.1, 0)
    ImageLabel.BackgroundTransparency = 1
    ImageLabel.Parent = ScreenGui

    local remoteEvent = ReplicatedStorage:WaitForChild("AvatarCopyEvent")

    -- Function to update avatar image preview
    local function updateAvatarImage(username)
        local success, userId = pcall(function()
            return Players:GetUserIdFromNameAsync(username)
        end)

        if success and userId then
            ImageLabel.Image = "https://www.roblox.com/bust-thumbnail/image?userId=" .. userId .. "&width=420&height=420&format=png"
        else
            ImageLabel.Image = ""
        end
    end

    -- Update avatar image when text changes
    TextBox:GetPropertyChangedSignal("Text"):Connect(function()
        updateAvatarImage(TextBox.Text)
    end)

    -- Connect button click to send request to the server
    Button.MouseButton1Click:Connect(function()
        local username = TextBox.Text
        if username and username ~= "" then
            remoteEvent:FireServer(username)
        end
    end)
end

-- Execute both server-side and client-side functions
addServerSideScript()
createClientGui()
