-- Create ServerScriptService if it does not exist
local function createServerScriptService()
    local serverScriptService = game:GetService("ServerScriptService")
    if not serverScriptService then
        serverScriptService = Instance.new("ServerScriptService")
        serverScriptService.Name = "ServerScriptService"
        serverScriptService.Parent = game
    end
    return serverScriptService
end

-- Function to create and add the server-side script
local function addServerSideScript()
    local serverScriptService = createServerScriptService()
    
    -- Check if the script already exists
    local existingScript = serverScriptService:FindFirstChild("AvatarCopyScript")
    if existingScript then
        existingScript:Destroy()
    end

    -- Create the server-side script
    local serverScript = Instance.new("Script")
    serverScript.Name = "AvatarCopyScript"
    serverScript.Source = [[
        -- Services
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")

        -- Function to apply the outfit of the target user
        local function applyOutfit(player, targetUserId)
            local character = player.Character
            if not character then return end

            -- Load the target user's avatar
            local targetPlayer = Players:GetPlayerByUserId(targetUserId)
            if not targetPlayer or not targetPlayer.Character then return end

            local targetCharacter = targetPlayer.Character
            local outfit = targetCharacter:GetChildren()

            -- Apply the target player's outfit to the current player
            for _, item in ipairs(outfit) do
                if item:IsA("Shirt") or item:IsA("Pants") or item:IsA("Hat") or item:IsA("Accessory") then
                    local newItem = item:Clone()
                    newItem.Parent = character
                end
            end
        end

        -- Setup RemoteEvents for communication
        local RemoteEvent = Instance.new("RemoteEvent")
        RemoteEvent.Name = "AvatarCopyEvent"
        RemoteEvent.Parent = ReplicatedStorage

        -- Connect RemoteEvent to handle requests
        RemoteEvent.OnServerEvent:Connect(function(player, targetUsername)
            local success, targetUserId = pcall(function()
                return Players:GetUserIdFromNameAsync(targetUsername)
            end)
            
            if success then
                applyOutfit(player, targetUserId)
            else
                warn("Failed to get user ID")
            end
        end)
    ]]
    serverScript.Parent = serverScriptService
end

-- Execute the function to add the server-side script
addServerSideScript()
